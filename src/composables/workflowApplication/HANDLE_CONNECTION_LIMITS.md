# Handle è¿æ¥æ•°é‡é™åˆ¶è¡¨

## ğŸ“Š å®Œæ•´é™åˆ¶è¡¨

| Handle ç±»å‹                    | æœ€å¤§è¾“å…¥è¿æ¥æ•° | æœ€å¤§è¾“å‡ºè¿æ¥æ•° | è¯´æ˜                                             |
| ------------------------------ | -------------- | -------------- | ------------------------------------------------ |
| **æ™®é€šè¾“å…¥** (INPUT)           | âˆ (-1)         | 0              | å¯ä»¥æ¥å—å¤šä¸ªè¾“å…¥è¿æ¥ï¼Œä¸èƒ½æœ‰è¾“å‡º                 |
| **æ™®é€šè¾“å‡º** (OUTPUT)          | 0              | **1**          | ä¸èƒ½æœ‰è¾“å…¥ï¼Œæ¯ä¸ªè¾“å‡º Handle åªèƒ½è¿æ¥ä¸€ä¸ªç›®æ ‡     |
| **åˆ†æ”¯è¾“å‡º** (BRANCH_OUTPUT)   | 0              | **1**          | ä¸èƒ½æœ‰è¾“å…¥ï¼Œæ¯ä¸ªåˆ†æ”¯ Handle åªèƒ½è¿æ¥ä¸€ä¸ªç›®æ ‡     |
| **å¹¶è¡Œè¾“å…¥** (PARALLEL_INPUT)  | 1              | 0              | åªèƒ½æ¥å—ä¸€ä¸ªè¾“å…¥ï¼ˆä»å¹¶è¡Œæ‰§è¡Œå™¨ï¼‰ï¼Œä¸èƒ½æœ‰è¾“å‡º     |
| **å¹¶è¡Œè¾“å‡º** (PARALLEL_OUTPUT) | 0              | **1**          | ä¸èƒ½æœ‰è¾“å…¥ï¼Œæ¯ä¸ªå¹¶è¡Œè¾“å‡º Handle åªèƒ½è¿æ¥ä¸€ä¸ªç›®æ ‡ |
| **å¾ªç¯è¾“å…¥** (LOOP_INPUT)      | 1              | 0              | åªèƒ½æ¥å—ä¸€ä¸ªè¾“å…¥ï¼Œä¸èƒ½æœ‰è¾“å‡º                     |
| **å¾ªç¯è¾“å‡º** (LOOP_OUTPUT)     | 0              | **1**          | ä¸èƒ½æœ‰è¾“å…¥ï¼Œæ¯ä¸ªå¾ªç¯è¾“å‡º Handle åªèƒ½è¿æ¥ä¸€ä¸ªç›®æ ‡ |

## ğŸ¯ å…³é”®æ¦‚å¿µ

### Handle çº§åˆ« vs èŠ‚ç‚¹çº§åˆ«

**é‡è¦ï¼šè¿™æ˜¯ Handle çº§åˆ«çš„é™åˆ¶ï¼Œä¸æ˜¯èŠ‚ç‚¹çº§åˆ«çš„é™åˆ¶ï¼**

#### âŒ é”™è¯¯ç†è§£ï¼ˆèŠ‚ç‚¹çº§åˆ«ï¼‰

```
æ¡ä»¶èŠ‚ç‚¹åªèƒ½æœ‰ 1 ä¸ªè¾“å‡ºè¿æ¥
```

#### âœ… æ­£ç¡®ç†è§£ï¼ˆHandle çº§åˆ«ï¼‰

```
æ¡ä»¶èŠ‚ç‚¹å¯ä»¥æœ‰ N ä¸ªåˆ†æ”¯ Handle
ä½†æ˜¯æ¯ä¸ªåˆ†æ”¯ Handle åªèƒ½æœ‰ 1 ä¸ªè¾“å‡ºè¿æ¥
```

## ğŸ“ å®é™…åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1ï¼šæ¡ä»¶èŠ‚ç‚¹ï¼ˆCONDITION_CHECKERï¼‰

```
æ¡ä»¶èŠ‚ç‚¹ï¼šcondition-123
â”œâ”€â”€ åˆ†æ”¯ Handle 1: condition-123-branch-true
â”‚   â””â”€â”€ å¯ä»¥è¿æ¥åˆ° 1 ä¸ªç›®æ ‡èŠ‚ç‚¹ âœ…
â”‚   â””â”€â”€ ä¸èƒ½è¿æ¥åˆ° 2 ä¸ªç›®æ ‡èŠ‚ç‚¹ âŒ
â”‚
â”œâ”€â”€ åˆ†æ”¯ Handle 2: condition-123-branch-false
â”‚   â””â”€â”€ å¯ä»¥è¿æ¥åˆ° 1 ä¸ªç›®æ ‡èŠ‚ç‚¹ âœ…
â”‚   â””â”€â”€ ä¸èƒ½è¿æ¥åˆ° 2 ä¸ªç›®æ ‡èŠ‚ç‚¹ âŒ
â”‚
â””â”€â”€ åˆ†æ”¯ Handle 3: condition-123-branch-default
    â””â”€â”€ å¯ä»¥è¿æ¥åˆ° 1 ä¸ªç›®æ ‡èŠ‚ç‚¹ âœ…
    â””â”€â”€ ä¸èƒ½è¿æ¥åˆ° 2 ä¸ªç›®æ ‡èŠ‚ç‚¹ âŒ
```

**æ€»ç»“ï¼š**

- æ¡ä»¶èŠ‚ç‚¹å¯ä»¥æœ‰ 3 ä¸ªåˆ†æ”¯ Handle
- æ¯ä¸ªåˆ†æ”¯ Handle åªèƒ½è¿æ¥åˆ° 1 ä¸ªç›®æ ‡èŠ‚ç‚¹
- æ‰€ä»¥æ¡ä»¶èŠ‚ç‚¹æ€»å…±å¯ä»¥æœ‰ 3 ä¸ªè¾“å‡ºè¿æ¥ï¼ˆæ¯ä¸ªåˆ†æ”¯ 1 ä¸ªï¼‰

### åœºæ™¯ 2ï¼šæ™®é€šèŠ‚ç‚¹ï¼ˆAPI_CALLERï¼‰

```
API è°ƒç”¨èŠ‚ç‚¹ï¼šapi-456
â””â”€â”€ æ™®é€šè¾“å‡º Handle: api-456-bottom
    â””â”€â”€ å¯ä»¥è¿æ¥åˆ° 1 ä¸ªç›®æ ‡èŠ‚ç‚¹ âœ…
    â””â”€â”€ ä¸èƒ½è¿æ¥åˆ° 2 ä¸ªç›®æ ‡èŠ‚ç‚¹ âŒ
```

**æ€»ç»“ï¼š**

- æ™®é€šèŠ‚ç‚¹åªæœ‰ 1 ä¸ªæ™®é€šè¾“å‡º Handle
- è¿™ä¸ª Handle åªèƒ½è¿æ¥åˆ° 1 ä¸ªç›®æ ‡èŠ‚ç‚¹

### åœºæ™¯ 3ï¼šå¹¶è¡Œæ‰§è¡Œå™¨ï¼ˆPARALLEL_EXECUTORï¼‰

```
å¹¶è¡Œæ‰§è¡Œå™¨ï¼šparallel-789
â”œâ”€â”€ å¹¶è¡Œè¾“å‡º Handle 1: parallel-789-parallel-0
â”‚   â””â”€â”€ å¯ä»¥è¿æ¥åˆ° 1 ä¸ªå­èŠ‚ç‚¹ âœ…
â”‚   â””â”€â”€ ä¸èƒ½è¿æ¥åˆ° 2 ä¸ªå­èŠ‚ç‚¹ âŒ
â”‚
â”œâ”€â”€ å¹¶è¡Œè¾“å‡º Handle 2: parallel-789-parallel-1
â”‚   â””â”€â”€ å¯ä»¥è¿æ¥åˆ° 1 ä¸ªå­èŠ‚ç‚¹ âœ…
â”‚   â””â”€â”€ ä¸èƒ½è¿æ¥åˆ° 2 ä¸ªå­èŠ‚ç‚¹ âŒ
â”‚
â””â”€â”€ æ™®é€šè¾“å‡º Handle: parallel-789-bottom
    â””â”€â”€ å¯ä»¥è¿æ¥åˆ° 1 ä¸ªç›®æ ‡èŠ‚ç‚¹ âœ…
    â””â”€â”€ ä¸èƒ½è¿æ¥åˆ° 2 ä¸ªç›®æ ‡èŠ‚ç‚¹ âŒ
```

**æ€»ç»“ï¼š**

- å¹¶è¡Œæ‰§è¡Œå™¨å¯ä»¥æœ‰ N ä¸ªå¹¶è¡Œè¾“å‡º Handle
- æ¯ä¸ªå¹¶è¡Œè¾“å‡º Handle åªèƒ½è¿æ¥åˆ° 1 ä¸ªå­èŠ‚ç‚¹
- å¹¶è¡Œæ‰§è¡Œå™¨è¿˜æœ‰ 1 ä¸ªæ™®é€šè¾“å‡º Handleï¼Œç”¨äºè¿æ¥åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

### åœºæ™¯ 4ï¼šæ™®é€šè¾“å…¥ Handle

```
ç›®æ ‡èŠ‚ç‚¹ï¼štarget-999
â””â”€â”€ æ™®é€šè¾“å…¥ Handle: target-999-top
    â”œâ”€â”€ å¯ä»¥æ¥å—æ¥è‡ª node-1 çš„è¿æ¥ âœ…
    â”œâ”€â”€ å¯ä»¥æ¥å—æ¥è‡ª node-2 çš„è¿æ¥ âœ…
    â”œâ”€â”€ å¯ä»¥æ¥å—æ¥è‡ª node-3 çš„è¿æ¥ âœ…
    â””â”€â”€ å¯ä»¥æ¥å—æ— é™ä¸ªè¾“å…¥è¿æ¥ âœ…
```

**æ€»ç»“ï¼š**

- æ™®é€šè¾“å…¥ Handle å¯ä»¥æ¥å—å¤šä¸ªè¾“å…¥è¿æ¥ï¼ˆæ— é™åˆ¶ï¼‰
- è¿™å…è®¸å¤šä¸ªèŠ‚ç‚¹è¿æ¥åˆ°åŒä¸€ä¸ªç›®æ ‡èŠ‚ç‚¹

## ğŸ” éªŒè¯é€»è¾‘

### æ£€æŸ¥æº Handle çš„è¾“å‡ºè¿æ¥æ•°

```typescript
// ç»Ÿè®¡è¯¥å…·ä½“ Handle å·²æœ‰çš„è¾“å‡ºè¿æ¥æ•°
const existingOutputEdges = allEdges.filter(
  e =>
    e.source === connection.source && e.sourceHandle === connection.sourceHandle // âš ï¸ å…³é”®ï¼šæ£€æŸ¥å…·ä½“çš„ Handle
);

// æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
if (existingOutputEdges.length >= sourceHandleLimits.maxOutputConnections) {
  return {
    success: false,
    error: `è¯¥ Handle å·²è¾¾åˆ°æœ€å¤§è¾“å‡ºè¿æ¥æ•°ï¼ˆ${sourceHandleLimits.maxOutputConnections}ï¼‰`
  };
}
```

### æ£€æŸ¥ç›®æ ‡ Handle çš„è¾“å…¥è¿æ¥æ•°

```typescript
// ç»Ÿè®¡è¯¥å…·ä½“ Handle å·²æœ‰çš„è¾“å…¥è¿æ¥æ•°
const existingInputEdges = allEdges.filter(
  e =>
    e.target === connection.target && e.targetHandle === connection.targetHandle // âš ï¸ å…³é”®ï¼šæ£€æŸ¥å…·ä½“çš„ Handle
);

// æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
if (existingInputEdges.length >= targetHandleLimits.maxInputConnections) {
  return {
    success: false,
    error: `è¯¥ Handle å·²è¾¾åˆ°æœ€å¤§è¾“å…¥è¿æ¥æ•°ï¼ˆ${targetHandleLimits.maxInputConnections}ï¼‰`
  };
}
```

## ğŸ¨ é”™è¯¯æç¤ºç¤ºä¾‹

### âœ… å‹å¥½çš„é”™è¯¯æç¤º

```typescript
// åœºæ™¯ 1ï¼šåˆ†æ”¯ Handle å·²æœ‰è¿æ¥
"æ¡ä»¶æ£€æŸ¥ çš„ã€Œåˆ†æ”¯è¾“å‡ºã€å·²è¾¾åˆ°æœ€å¤§è¾“å‡ºè¿æ¥æ•°ï¼ˆ1ï¼‰";

// åœºæ™¯ 2ï¼šæ™®é€šè¾“å‡º Handle å·²æœ‰è¿æ¥
"API è°ƒç”¨ çš„ã€Œæ™®é€šè¾“å‡ºã€å·²è¾¾åˆ°æœ€å¤§è¾“å‡ºè¿æ¥æ•°ï¼ˆ1ï¼‰";

// åœºæ™¯ 3ï¼šå¹¶è¡Œè¾“å…¥ Handle å·²æœ‰è¿æ¥
"æ•°æ®å¤„ç† çš„ã€Œå¹¶è¡Œè¾“å…¥ã€å·²è¾¾åˆ°æœ€å¤§è¾“å…¥è¿æ¥æ•°ï¼ˆ1ï¼‰";
```

## ğŸ“‹ é…ç½®è¡¨ï¼ˆä»£ç ï¼‰

```typescript
export const HANDLE_CONNECTION_LIMITS: Record<
  HandleType,
  HandleConnectionLimits
> = {
  // ========== è¾“å…¥ç±»å‹ ==========
  [HandleType.INPUT]: {
    maxInputConnections: -1, // å¯ä»¥æ¥å—å¤šä¸ªè¾“å…¥è¿æ¥
    maxOutputConnections: 0 // è¾“å…¥ Handle ä¸èƒ½æœ‰è¾“å‡º
  },

  [HandleType.PARALLEL_INPUT]: {
    maxInputConnections: 1, // å¹¶è¡Œè¾“å…¥åªèƒ½æ¥å—ä¸€ä¸ªè¿æ¥ï¼ˆä»å¹¶è¡Œæ‰§è¡Œå™¨ï¼‰
    maxOutputConnections: 0 // è¾“å…¥ Handle ä¸èƒ½æœ‰è¾“å‡º
  },

  [HandleType.LOOP_INPUT]: {
    maxInputConnections: 1, // å¾ªç¯è¾“å…¥åªèƒ½æ¥å—ä¸€ä¸ªè¿æ¥
    maxOutputConnections: 0 // è¾“å…¥ Handle ä¸èƒ½æœ‰è¾“å‡º
  },

  // ========== è¾“å‡ºç±»å‹ ==========
  [HandleType.OUTPUT]: {
    maxInputConnections: 0, // è¾“å‡º Handle ä¸èƒ½æœ‰è¾“å…¥
    maxOutputConnections: 1 // âš ï¸ æ¯ä¸ªæ™®é€šè¾“å‡º Handle åªèƒ½æœ‰ä¸€ä¸ªè¾“å‡ºè¿æ¥
  },

  [HandleType.BRANCH_OUTPUT]: {
    maxInputConnections: 0, // è¾“å‡º Handle ä¸èƒ½æœ‰è¾“å…¥
    maxOutputConnections: 1 // âš ï¸ æ¯ä¸ªåˆ†æ”¯è¾“å‡º Handle åªèƒ½æœ‰ä¸€ä¸ªè¾“å‡ºè¿æ¥
  },

  [HandleType.PARALLEL_OUTPUT]: {
    maxInputConnections: 0, // è¾“å‡º Handle ä¸èƒ½æœ‰è¾“å…¥
    maxOutputConnections: 1 // âš ï¸ æ¯ä¸ªå¹¶è¡Œè¾“å‡º Handle åªèƒ½æœ‰ä¸€ä¸ªè¾“å‡ºè¿æ¥
  },

  [HandleType.LOOP_OUTPUT]: {
    maxInputConnections: 0, // è¾“å‡º Handle ä¸èƒ½æœ‰è¾“å…¥
    maxOutputConnections: 1 // âš ï¸ æ¯ä¸ªå¾ªç¯è¾“å‡º Handle åªèƒ½æœ‰ä¸€ä¸ªè¾“å‡ºè¿æ¥
  }
};
```

## ğŸš€ å¦‚ä½•ä¿®æ”¹é™åˆ¶

### ç¤ºä¾‹ï¼šå…è®¸æ™®é€šè¾“å‡º Handle è¿æ¥åˆ°å¤šä¸ªç›®æ ‡

```typescript
[HandleType.OUTPUT]: {
  maxInputConnections: 0,
  maxOutputConnections: -1  // ä¿®æ”¹ä¸º -1 è¡¨ç¤ºæ— é™åˆ¶
}
```

### ç¤ºä¾‹ï¼šé™åˆ¶æ™®é€šè¾“å…¥ Handle åªèƒ½æ¥å— 3 ä¸ªè¾“å…¥

```typescript
[HandleType.INPUT]: {
  maxInputConnections: 3,   // ä¿®æ”¹ä¸º 3
  maxOutputConnections: 0
}
```

## ğŸ“ æ€»ç»“

1. **Handle çº§åˆ«é™åˆ¶**ï¼šæ¯ä¸ªå…·ä½“çš„ Handle éƒ½æœ‰ç‹¬ç«‹çš„è¿æ¥æ•°é‡é™åˆ¶
2. **èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ª Handle**ï¼šä¾‹å¦‚æ¡ä»¶èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªåˆ†æ”¯ Handle
3. **æ¯ä¸ªè¾“å‡º Handle åªèƒ½æœ‰ 1 ä¸ªè¾“å‡º**ï¼šè¿™æ˜¯æœ€é‡è¦çš„è§„åˆ™
4. **æ™®é€šè¾“å…¥ Handle å¯ä»¥æ¥å—å¤šä¸ªè¾“å…¥**ï¼šå…è®¸å¤šä¸ªèŠ‚ç‚¹è¿æ¥åˆ°åŒä¸€ä¸ªç›®æ ‡

è¿™ä¸ªè®¾è®¡ç¡®ä¿äº†å·¥ä½œæµçš„æ¸…æ™°æ€§å’Œå¯ç»´æŠ¤æ€§ï¼ğŸ‰
