# 节点连接矩阵

本文档展示了工作流系统中所有节点类型之间的连接规则。

## 📊 连接矩阵说明

- ✅ = 允许连接
- ❌ = 不允许连接

矩阵格式：`[源节点类型] → [目标节点类型]`

## 🎯 连接类型说明

工作流系统支持以下4种连接类型：

1. **普通输出 → 普通输入** (`NORMAL_TO_NORMAL`)
   - 最常见的顺序连接
   - 用于连接工作流中的顺序节点
   - 例如：开始节点 → API调用器 → 结束节点

2. **分支输出 → 普通输入** (`BRANCH_TO_NORMAL`)
   - 条件节点的分支连接
   - 用于根据条件分支到不同的执行路径
   - 例如：条件节点 → [分支1: API调用器, 分支2: 数据处理器]

3. **并行输出 → 并行输入** (`PARALLEL_TO_PARALLEL`)
   - 并行执行器的子节点连接
   - 用于并行执行多个任务
   - 例如：并行执行器 → [子任务1, 子任务2, 子任务3]

4. **循环输出 → 循环输入** (`LOOP_TO_LOOP`)
   - 循环节点的回路连接（预留功能）
   - 用于实现循环逻辑
   - 当前版本尚未实现

## 🔗 普通输出 → 普通输入

普通连接是最常见的连接类型，用于连接工作流中的顺序节点。

| 源\目标  | 开始 | 任务 | 条件 | API | 处理 | 循环 | 结束 | 并行 | LLM |
| -------- | ---- | ---- | ---- | --- | ---- | ---- | ---- | ---- | --- |
| **开始** | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ✅   | ✅  |
| **任务** | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ✅   | ✅  |
| **条件** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **API**  | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ✅   | ✅  |
| **处理** | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ✅   | ✅  |
| **循环** | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ✅   | ✅  |
| **结束** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **并行** | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ✅   | ✅  |
| **LLM**  | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ✅   | ✅  |

**规则说明：**

- 开始节点不能连接到开始节点（特殊规则）
- 条件节点不支持普通输出（只能通过分支连接）
- 结束节点不能有任何输出连接

## 🌿 分支输出 → 普通输入

分支连接用于条件节点的分支输出，连接到其他节点的普通输入。

| 源\目标  | 开始 | 任务 | 条件 | API | 处理 | 循环 | 结束 | 并行 | LLM |
| -------- | ---- | ---- | ---- | --- | ---- | ---- | ---- | ---- | --- |
| **开始** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **任务** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **条件** | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ✅   | ✅  |
| **API**  | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **处理** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **循环** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **结束** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **并行** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **LLM**  | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |

**规则说明：**

- 只有条件节点支持分支输出
- 条件节点可以连接到任何可以被连接的节点（除了开始节点）

## 🔀 并行输出 → 并行输入

并行连接用于并行执行器的子节点连接，连接到其他节点的并行输入。

| 源\目标  | 开始 | 任务 | 条件 | API | 处理 | 循环 | 结束 | 并行 | LLM |
| -------- | ---- | ---- | ---- | --- | ---- | ---- | ---- | ---- | --- |
| **开始** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **任务** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **条件** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **API**  | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **处理** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **循环** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **结束** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **并行** | ❌   | ✅   | ✅   | ✅  | ✅   | ✅   | ✅   | ❌   | ✅  |
| **LLM**  | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |

**规则说明：**

- 只有并行执行器支持并行输出
- 并行执行器可以连接到任何可以被连接的节点（除了开始节点和并行执行器本身）

## 🔄 循环输出 → 循环输入

循环连接用于循环节点的回路连接（预留功能，当前版本尚未实现）。

| 源\目标  | 开始 | 任务 | 条件 | API | 处理 | 循环 | 结束 | 并行 | LLM |
| -------- | ---- | ---- | ---- | --- | ---- | ---- | ---- | ---- | --- |
| **开始** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **任务** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **条件** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **API**  | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **处理** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **循环** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **结束** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **并行** | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |
| **LLM**  | ❌   | ❌   | ❌   | ❌  | ❌   | ❌   | ❌   | ❌   | ❌  |

**规则说明：**

- 循环连接功能尚未实现
- 预留用于实现循环逻辑（如 While 循环的回路）

## 📝 节点类型说明

| 节点类型            | 简称 | 说明                                 |
| ------------------- | ---- | ------------------------------------ |
| USER_INPUT          | 开始 | 工作流的起始节点，不能被其他节点连接 |
| TODO_TASK_GENERATOR | 任务 | 任务生成器节点                       |
| CONDITION_CHECKER   | 条件 | 条件检查器，只能通过分支连接输出     |
| API_CALLER          | API  | API 调用器节点                       |
| DATA_PROCESSOR      | 处理 | 数据处理器节点                       |
| WHILE_LOOP          | 循环 | While 循环节点                       |
| END_NODE            | 结束 | 工作流的结束节点，不能有任何输出     |
| PARALLEL_EXECUTOR   | 并行 | 并行执行器，可以有并行子节点         |
| LLM_CALLER          | LLM  | LLM 调用器节点                       |

## 🔧 如何生成此文档

使用 `connectionMatrixGenerator.ts` 中的工具函数：

```typescript
import {
  printConnectionMatrix,
  exportConnectionMatrixAsMarkdown
} from "./connectionMatrixGenerator";

// 在控制台打印矩阵
printConnectionMatrix();

// 导出为 Markdown
const markdown = exportConnectionMatrixAsMarkdown();
console.log(markdown);
```

## 🎯 如何添加新的节点类型

1. 在 `edgeValidation.ts` 的 `NODE_OUTPUT_RULES` 中添加输出规则
2. 在 `edgeValidation.ts` 的 `NODE_INPUT_RULES` 中添加输入规则
3. 如果有特殊规则，在 `getConnectionRuleFromMatrix()` 中添加
4. 重新生成此文档

示例：

```typescript
// 1. 添加输出规则
const NODE_OUTPUT_RULES: Record<string, NodeOutputRule> = {
  // ... 其他规则
  [NodeTypeEnum.NEW_NODE_TYPE]: {
    canHaveNormalOutput: true,
    canHaveBranchOutput: false,
    canHaveParallelOutput: false,
    maxNormalOutputs: 1,
    maxBranchOutputs: 0,
    maxParallelOutputs: 0
  }
};

// 2. 添加输入规则
const NODE_INPUT_RULES: Record<string, NodeInputRule> = {
  // ... 其他规则
  [NodeTypeEnum.NEW_NODE_TYPE]: {
    canBeTarget: true,
    maxInputs: -1  // 无限制
  }
};

// 3. 如果需要，添加特殊规则
function getConnectionRuleFromMatrix(...) {
  // 特殊规则
  if (sourceType === NodeTypeEnum.NEW_NODE_TYPE && targetType === NodeTypeEnum.SOME_TYPE) {
    return {
      allowed: false,
      reason: "特殊业务规则说明"
    };
  }
  // ... 其他逻辑
}
```

## 📚 相关文档

- [README.md](./README.md) - 架构说明
- [edgeValidation.ts](./edgeValidation.ts) - 验证逻辑实现
- [connectionMatrixGenerator.ts](./connectionMatrixGenerator.ts) - 矩阵生成器

---

**注意：** 此文档是基于当前的节点类型和规则配置自动生成的。如果规则发生变化，请重新生成此文档。
